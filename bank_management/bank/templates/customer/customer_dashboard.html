{% extends 'base.html' %} {% block content %}

<div class="container mt-4">
  <!-- Header -->
  <div class="text-center mb-4">
    <h2 class="fw-bold">Welcome, {{ customer_name }}</h2>
    <p class="text-muted">Your account overview</p>
  </div>

  <!-- Account Summary -->
  <div class="row g-4 mb-4">
    <div class="col-md-3">
      <div class="card shadow-sm border-0 text-center p-3">
        <i class="bi bi-person-circle fs-2 text-primary"></i>
        <p class="mt-2 mb-1 text-muted">Customer</p>
        <h6>{{ customer_name }}</h6>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm border-0 text-center p-3">
        <i class="bi bi-bank fs-2 text-success"></i>
        <p class="mt-2 mb-1 text-muted">Branch</p>
        <h6>{{ customer_branch }}</h6>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm border-0 text-center p-3">
        <i class="bi bi-person-badge fs-2 text-warning"></i>
        <p class="mt-2 mb-1 text-muted">Manager</p>
        <h6>{{ manager_names }}</h6>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm border-0 text-center p-3">
        <i class="bi bi-credit-card fs-2 text-danger"></i>
        <p class="mt-2 mb-1 text-muted">Account No</p>
        <h6>{{ account_number }}</h6>
      </div>
    </div>
  </div>

  <!-- Actions -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body text-center">
      <a href="{% url 'send_message' %}" class="btn btn-warning btn-lg me-2">
        <i class="bi bi-envelope-fill me-1"></i> Contact Manager
      </a>

      <form
        method="post"
        action="{% url 'disable_account_request' %}"
        class="d-inline"
      >
        {% csrf_token %}
        <button class="btn btn-outline-danger btn-lg">
          <i class="bi bi-x-circle me-1"></i> Disable Account
        </button>
      </form>
    </div>
  </div>

  <!-- Manager Reply -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-light fw-bold">
      <i class="bi bi-chat-left-text me-2"></i>Manager Messages
    </div>
    <div class="card-body">
      {% if reply %}
      <div class="alert alert-success mb-0">{{ reply }}</div>
      {% else %}
      <p class="text-muted mb-0">No messages from manager yet.</p>
      {% endif %}
    </div>
  </div>

  <!-- QR Code & UPI -->
  <div class="row g-4">
    <!-- QR Section -->
    <div class="col-md-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header bg-light fw-bold">
          <i class="bi bi-qr-code me-2"></i>Secure QR Access
        </div>
        <div class="card-body text-center">
          <div id="qrContainer" class="mb-3"></div>

          <button id="showQrBtn" class="btn btn-warning btn-lg">
            Show QR Code
          </button>

          <div id="qrTimer" class="mt-2 text-muted" style="display: none">
            QR expires in <span id="seconds">60</span> seconds
          </div>
        </div>
      </div>
    </div>

    <!-- UPI Section -->
    <div class="col-md-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header bg-light fw-bold">
          <i class="bi bi-wallet2 me-2"></i>UPI Details
        </div>
        <div class="card-body text-center">
          {% if not profile.upi_id %}
          <form method="post">
            {% csrf_token %}
            <button type="submit" class="btn btn-success btn-lg">
              Create UPI ID
            </button>
          </form>
          {% else %}
          <h5 class="text-success">{{ profile.upi_id }}</h5>
          <p class="text-muted">Your active UPI ID</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.getElementById("showQrBtn").addEventListener("click", function () {
    const container = document.getElementById("qrContainer");
    const timerDiv = document.getElementById("qrTimer");
    const secondsSpan = document.getElementById("seconds");

    container.innerHTML = "";

    const qrImg = document.createElement("img");
    qrImg.src = "data:image/png;base64,{{ qr_base64 }}";
    qrImg.style.width = "180px";

    container.appendChild(qrImg);
    timerDiv.style.display = "block";

    let secondsLeft = 60;
    secondsSpan.innerText = secondsLeft;

    const countdown = setInterval(() => {
      secondsLeft--;
      secondsSpan.innerText = secondsLeft;

      if (secondsLeft <= 0) {
        clearInterval(countdown);
        container.innerHTML = "";
        timerDiv.style.display = "none";
      }
    }, 1000);
  });
</script>

{% endblock %}
